name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  clang-checks:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0

    - name: Install clang tools and dependencies
      run: |
        apt-get update
        apt-get install -y clang clang-format clang-tidy git

    - name: Update submodules
      run: |
        git submodule init
        git submodule update

    - name: Build project to generate compile_commands.json
      run: |
        mkdir -p build
        cd build
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..
        # Build to ensure all dependencies are resolved
        cmake --build . --parallel 2

    - name: Check code formatting with clang-format
      run: |
        # Only check thulr source files (excluding tests if needed)
        find source/projects -name "*.cpp" -o -name "*.hpp" | grep -v "_test" | xargs clang-format --dry-run --Werror

    - name: Check code quality with clang-tidy
      run: |
        # Run clang-tidy only on thulr source files, excluding tests
        find source/projects -name "*.cpp" | grep -v "_test" | xargs -I {} clang-tidy {} \
          -p build \
          -header-filter='.*' \
          -quiet \
          --extra-arg="-I/usr/include" \
          --extra-arg="-I./build/_deps/catch2-src/src" \
          --extra-arg="-I./build/_deps/catch2-src/include" \
          -checks='-*,bugprone-*,clang-analyzer-*,modernize-*,performance-*,readability-*,-bugprone-branch-clone,-bugprone-easily-swappable-parameters,-modernize-use-trailing-return-type,-readability-identifier-length,-readability-magic-numbers,-readability-function-cognitive-complexity'

    - name: Auto-fix formatting issues
      if: failure()
      run: |
        # Apply clang-format fixes only to thulr (excluding tests)
        find source/projects -name "*.cpp" -o -name "*.hpp" | grep -v "_test" | xargs clang-format -i
        
        # Create patch file for review
        git diff > clang-format-fixes.patch
        
        echo "=== Formatting fixes applied to thulr ==="
        echo "Review the changes in clang-format-fixes.patch"
        
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: clang-format-fixes
        path: clang-format-fixes.patch
