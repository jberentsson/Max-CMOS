name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']  # Trigger on version tags
  pull_request:
    branches: [main, develop]

# Add concurrency to prevent multiple runs on same commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CMAKE_VERSION: '3.27.7'  # Pin CMake version for reproducibility
  BUILD_DIR: 'build'
  PACKAGE_NAME: ${{ github.event.repository.name }}

jobs:
  # Job 1: Code Quality Checks
  clang-tidy:
    runs-on: ubuntu-latest  # Use larger runner for faster builds
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0  # Fetch all history for better analysis
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.npm
          /tmp/build-deps
        key: ${{ runner.os }}-deps-${{ hashFiles('**/CMakeLists.txt') }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy-15 \
          clang-15 \
          cmake \
          make \
          ninja-build \
          lcov \
          python3-pip
        sudo pip3 install cpplint
    
    - name: Run clang-tidy
      run: |
        # Create compile_commands.json for clang-tidy
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -G Ninja
        
        # Run clang-tidy on modified files for PRs, all files for pushes
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          git diff --name-only $BASE_SHA $HEAD_SHA -- '*.cpp' '*.hpp' '*.c' '*.h' | \
            xargs -I {} clang-tidy-15 {} -- -I. -I./${{ env.BUILD_DIR }}
        else
          find . -name '*.cpp' -o -name '*.hpp' -o -name '*.c' -o -name '*.h' | \
            xargs clang-tidy-15 -- -I. -I./${{ env.BUILD_DIR }}
        fi
    
    - name: Run cppcheck
      run: |
        sudo apt-get install -y cppcheck
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --language=c++ --std=c++17 --inline-suppr \
          -I. -I./${{ env.BUILD_DIR }} \
          --error-exitcode=1 \
          source/

  # Job 2: Build and Test on Multiple Platforms
  build-test:
    runs-on: ${{ matrix.os }}
    needs: [clang-tidy]  # Run after code quality checks
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        config: [Debug, Release]
        include:
          - os: ubuntu-latest
            build-type: Debug
            generator: "Unix Makefiles"
          - os: macos-latest
            build-type: Release
            generator: "Unix Makefiles"
          - os: windows-latest
            build-type: Release
            generator: "Visual Studio 17 2022"
            arch: x64
        #fail-fast: false  # Don't stop other matrix builds if one fails
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 1
    
    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}
    
    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: ${{ env.BUILD_DIR }}
        key: ${{ runner.os }}-${{ matrix.config }}-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.hpp') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.config }}-
    
    - name: Configure CMake
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        
        cmake .. \
          -G "${{ matrix.generator }}" \
          -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
          -DCMAKE_POLICY_VERSION_MINIMUM="3.5" \
          -DBUILD_TESTING=ON \
          -DCMAKE_CXX_FLAGS="${{ matrix.config == 'Debug' && '-g -O0 -fsanitize=address' || '-O3 -DNDEBUG' }}"
        
        # Windows-specific flags
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake .. -A ${{ matrix.arch }}
        fi
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        cmake --build . --config ${{ matrix.config }} --parallel ${{ (runner.os == 'Windows' && 4) || (runner.os == 'macOS' && 3) || 2 }}
    
    - name: Run Tests
      run: |
        cd ${{ env.BUILD_DIR }}
        if [ "${{ runner.os }}" = "Windows" ]; then
          ctest -C ${{ matrix.config }} --output-on-failure --parallel 4
        else
          ctest -C ${{ matrix.config }} --output-on-failure --parallel 2
        fi
    
    - name: Upload Test Results
      if: always()  # Upload even if tests fail
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ runner.os }}-${{ matrix.config }}
        path: |
          ${{ env.BUILD_DIR }}/Testing/**/*.xml
          ${{ env.BUILD_DIR }}/**/*.gcov
          ${{ env.BUILD_DIR }}/**/*.gcda
          ${{ env.BUILD_DIR }}/**/*.gcno
    
    - name: Generate Coverage Report (Linux/Debug only)
      if: runner.os == 'Linux' && matrix.config == 'Debug'
      run: |
        cd ${{ env.BUILD_DIR }}
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --list coverage.info
    
    - name: Upload Coverage to Codecov
      if: runner.os == 'Linux' && matrix.config == 'Debug'
      uses: codecov/codecov-action@v3
      with:
        file: ${{ env.BUILD_DIR }}/coverage.info
        flags: unittests
        name: codecov-umbrella

  # Job 3: Package Release Builds
  package:
    runs-on: ${{ matrix.os }}
    needs: [build-test]  # Only package after successful tests
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        config: [Release]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 1
    
    - name: Set version info
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
          VERSION="main-${GITHUB_SHA:0:7}"
        else
          VERSION="develop-${GITHUB_SHA:0:7}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
    
    - name: Build Release
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        
        if [ "${{ runner.os }}" = "macOS" ]; then
          cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_POLICY_VERSION_MINIMUM="3.5"
        else
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_POLICY_VERSION_MINIMUM="3.5"
        fi
        
        cmake --build . --config Release --parallel 4
    
    - name: Create Package Directory Structure
      run: |
        mkdir -p "${{ env.PACKAGE_NAME }}"
        
        # Copy essential files with proper structure
        cp -r source "${{ env.PACKAGE_NAME }}/"
        cp -r externals "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r support "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r examples "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r docs "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        
        # Copy root-level files
        for file in *.md LICENSE README* CHANGELOG*; do
          [ -f "$file" ] && cp "$file" "${{ env.PACKAGE_NAME }}/"
        done
        
        # Create package-info.json if it doesn't exist
        if [ ! -f "package-info.json" ]; then
          cat > "${{ env.PACKAGE_NAME }}/package-info.json" << EOF
        {
          "name": "${{ env.PACKAGE_NAME }}",
          "version": "${{ env.VERSION }}",
          "description": "Max/MSP external built from ${{ github.repository }}",
          "homepage": "https://github.com/${{ github.repository }}",
          "author": "${{ github.actor }}",
          "repository": "${{ github.repository_url }}"
        }
        EOF
        else
          cp package-info.json "${{ env.PACKAGE_NAME }}/"
        fi
        
        # Add build info file
        echo "Build: ${{ env.VERSION }}" > "${{ env.PACKAGE_NAME }}/BUILD_INFO"
        echo "Commit: ${{ github.sha }}" >> "${{ env.PACKAGE_NAME }}/BUILD_INFO"
        echo "Date: $(date -u)" >> "${{ env.PACKAGE_NAME }}/BUILD_INFO"
        echo "Platform: ${{ runner.os }}" >> "${{ env.PACKAGE_NAME }}/BUILD_INFO"
    
    - name: Package for Distribution
      run: |
        ZIP_NAME="${{ env.PACKAGE_NAME }}-${{ env.VERSION }}-${{ runner.os }}-${{ matrix.config }}.zip"
        
        if [ "${{ runner.os }}" = "macOS" ]; then
          # macOS: Create proper bundle structure
          mkdir -p "${{ env.PACKAGE_NAME }}.mxo"
          cp -r "${{ env.PACKAGE_NAME }}"/* "${{ env.PACKAGE_NAME }}.mxo/"
          zip -r "$ZIP_NAME" "${{ env.PACKAGE_NAME }}.mxo"
        else
          # Windows: Simple zip
          zip -r "$ZIP_NAME" "${{ env.PACKAGE_NAME }}"
        fi
        
        echo "PACKAGE_PATH=$ZIP_NAME" >> $GITHUB_ENV
    
    - name: Upload Package Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ env.VERSION }}-${{ runner.os }}
        path: ${{ env.PACKAGE_PATH }}
        retention-days: 30

  # Job 4: Create GitHub Release
  release:
    runs-on: ubuntu-latest
    needs: [package]
    if: startsWith(github.ref, 'refs/tags/v')  # Only create releases for version tags
    
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Download All Package Artifacts
      run: |
        mkdir -p packages
        artifacts=$(gh api /repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | select(.name | startswith("${{ env.PACKAGE_NAME }}")) | .id')
        for artifact_id in $artifacts; do
          gh run download $artifact_id --dir packages
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Release ${{ github.ref_name }}
          
          **Build Information:**
          - Commit: ${{ github.sha }}
          - Built on: macOS, Windows
          - Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          **Changes:**
          ${{ github.event.head_commit.message }}
          
          **Download:** Attached packages for each platform.
          
          ### Installation
          1. Download the appropriate package for your OS
          2. Extract to your Max/MSP packages folder
          3. Restart Max/MSP
          
          ### Supported Platforms
          - macOS (Apple Silicon + Intel)
          - Windows (64-bit)
          
          ### SHA256 Checksums
          ```
          ${{ steps.checksums.outputs.checksums }}
          ```
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}  # Mark as pre-release if tag contains hyphen
        files: |
          packages/*.zip
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Generate SHA256 Checksums
      id: checksums
      run: |
        cd packages
        for file in *.zip; do
          sha256sum "$file" >> checksums.txt
        done
        echo "checksums=$(cat checksums.txt)" >> $GITHUB_OUTPUT
