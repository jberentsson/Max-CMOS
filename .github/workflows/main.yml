name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Job 1: Code Quality Checks
  clang-tidy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cmake make

    - name: Run clang-tidy
      run: make tidy-ci

  # Job 2: Build, Test, and Package
  build-test-package:
    runs-on: ${{ matrix.os }}
    needs: [clang-tidy]  # Run after clang-tidy passes
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        config: [debug, release]
        include:
          - os: ubuntu-latest
            config: debug
            arch: linux

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: '1'
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set short SHA
      id: sha
      run: echo "sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

    - name: Configure macOS
      if: matrix.os == 'macos-latest'
      run: |
        mkdir -p build
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_POLICY_VERSION_MINIMUM="3.5" \
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
 
    - name: Configure Windows
      if: matrix.os == 'windows-latest'
      run: |
        mkdir -p build
        cd build
        cmake .. -G "Visual Studio 17 2022" \
          -DCMAKE_POLICY_VERSION_MINIMUM="3.5"

    - name: Configure Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p build
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_POLICY_VERSION_MINIMUM="3.5" \
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}

    - name: Build Debug
      if: matrix.config == 'debug'
      run: cmake --build build --config 'Debug' --verbose

    - name: Build Release
      if: matrix.config == 'release'
      run: cmake --build build --config 'Release' --verbose

    - name: Run Tests
      run: cd build && ctest -C ${{ matrix.config }} . -V

    - name: Package macOS
      if: matrix.os == 'macos-latest' && matrix.config == 'release'
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        SHORT_SHA: ${{ steps.sha.outputs.sha }}
      run: |
        PACKAGE_NAME=$(echo $GITHUB_REPOSITORY | sed 's/.*\///g')
        PACKAGE_REV="$SHORT_SHA"
        mkdir -p "$PACKAGE_NAME"
        
        # Copy files
        [ -e package-info.json ] && cp package-info.json "$PACKAGE_NAME"
        [ -e package-info.json.in ] && cp package-info.json.in "$PACKAGE_NAME"
        for f in *.md; do [ -e "$f" ] && cp "$f" "$PACKAGE_NAME"; done
        [ -e icon.png ] && cp icon.png "$PACKAGE_NAME"
        [ -e CMakeLists.txt ] && cp CMakeLists.txt "$PACKAGE_NAME"
        
        # Copy directories
        [ -d code ] && cp -a code "$PACKAGE_NAME"
        [ -d docs ] && cp -a docs "$PACKAGE_NAME"
        [ -d examples ] && cp -a examples "$PACKAGE_NAME"
        [ -d extensions ] && cp -a extensions "$PACKAGE_NAME"
        [ -d externals ] && cp -a externals "$PACKAGE_NAME"
        [ -d extras ] && cp -a extras "$PACKAGE_NAME"
        [ -d help ] && cp -a help "$PACKAGE_NAME"
        [ -d init ] && cp -a init "$PACKAGE_NAME"
        [ -d java-classes ] && cp -a java-classes "$PACKAGE_NAME"
        [ -d java-doc ] && cp -a java-doc "$PACKAGE_NAME"
        [ -d javascript ] && cp -a javascript "$PACKAGE_NAME"
        [ -d jsui ] && cp -a jsui "$PACKAGE_NAME"
        [ -d media ] && cp -a media "$PACKAGE_NAME"
        [ -d misc ] && cp -a misc "$PACKAGE_NAME"
        [ -d patchers ] && cp -a patchers "$PACKAGE_NAME"
        [ -d script ] && cp -a script "$PACKAGE_NAME"
        [ -d support ] && cp -a support "$PACKAGE_NAME"
        [ -d source ] && cp -a source "$PACKAGE_NAME"
        [ -d tests ] && cp -a tests "$PACKAGE_NAME"
        
        # Handle ReadMe
        if [ -e "$PACKAGE_NAME/ReadMe-Public.md" ]; then 
          rm -f "$PACKAGE_NAME/ReadMe.md"
          mv "$PACKAGE_NAME/ReadMe-Public.md" "$PACKAGE_NAME/ReadMe.md"
        fi

    - name: Package Windows
      if: matrix.os == 'windows-latest' && matrix.config == 'release'
      shell: cmd
      env:
        GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
        SHORT_SHA: ${{ steps.sha.outputs.sha }}
      run: |
        set PACKAGE_NAME=%GITHUB_REPOSITORY_NAME%
        mkdir %PACKAGE_NAME%
        if exist extensions xcopy /s /e /i extensions %PACKAGE_NAME%\extensions
        if exist externals xcopy /s /e /i externals %PACKAGE_NAME%\externals
        if exist support xcopy /s /e /i support %PACKAGE_NAME%\support
        if exist tests xcopy /s /e /i tests %PACKAGE_NAME%\tests

    - uses: actions/upload-artifact@v4
      if: matrix.config == 'release'
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-${{ matrix.config }}-${{ matrix.os }}
        path: ${{ github.event.repository.name }}

  # Job 3: Create Release
  release:
    runs-on: ubuntu-latest
    needs: [build-test-package]  # Run after successful build
    if: ${{ contains(github.ref, 'refs/tags/') }}  # Only run on tags
    
    steps:
    - name: Set short SHA
      id: sha
      run: echo "sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

    - name: Download macOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-release-macos-latest
        
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-release-windows-latest
    
    - name: Display structure of downloaded files
      run: |
        echo "Contents of current directory:"
        ls -la
        echo ""
        echo "Looking for package directories:"
        find . -type d -name "${{ github.event.repository.name }}" | head -5

    - name: Create Release ZIP
      run: |
        # Find the actual package directory
        PACKAGE_DIR=$(find . -type d -name "${{ github.event.repository.name }}" | head -1)
        if [ -z "$PACKAGE_DIR" ]; then
          echo "ERROR: Package directory not found!"
          exit 1
        fi
        
        echo "Found package directory: $PACKAGE_DIR"
        zip -r ${{ github.event.repository.name }}-package-for-max-${{ steps.sha.outputs.sha }}.zip "$PACKAGE_DIR"

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-zipped-release
        path: ${{ github.event.repository.name }}-package-for-max-${{ steps.sha.outputs.sha }}.zip

    - uses: ncipollo/release-action@v1.12.0
      with:
        artifacts: ${{ github.event.repository.name }}-package-for-max-${{ steps.sha.outputs.sha }}.zip
        body: |
          Max Package for all supported platforms
          
          **Build Information:**
          - Commit: ${{ steps.sha.outputs.sha }}
          - Tag: ${{ github.ref_name }}
          - Built on: macOS, Windows
        token: ${{ secrets.GITHUB_TOKEN }}
