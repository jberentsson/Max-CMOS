name: Release

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  BADGE_LABEL: ${{ github.ref == 'refs/heads/main' && 'main' || github.ref == 'refs/heads/develop' && 'develop' || 'ci' }}

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install clang tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cmake make

    - name: Check code quality with clang-tidy
      run: make tidy-ci || echo "tidy-ci completed"

  package:
    needs: [code-quality]  # Run after code quality checks
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ macos-latest, windows-latest ]
        config: [ debug, release ]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: '1'
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set short SHA
      id: sha
      run: echo "sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

    - name: configure_macos
      if: matrix.os == 'macos-latest'
      run: |
        mkdir build
        cd build
        cmake .. -G "Unix Makefiles" -DCMAKE_POLICY_VERSION_MINIMUM="3.5" -DCMAKE_BUILD_TYPE=${{ matrix.config }}
 
    - name: configure_windows
      if: matrix.os == 'windows-latest'
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -DCMAKE_POLICY_VERSION_MINIMUM="3.5"

    - name: build_debug
      if: matrix.config == 'debug'
      run: cmake --build build --config 'Debug' --verbose

    - name: build_release
      if: matrix.config == 'release'
      run: cmake --build build --config 'Release' --verbose

    - name: test
      run: cd build && ctest -C ${{ matrix.config }} . -V

    - name: package_macos
      if: matrix.os == 'macos-latest'
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_CONFIG: ${{ matrix.config }}
        SHORT_SHA: ${{ steps.sha.outputs.sha }}
      run: |
        PACKAGE_NAME=`echo $GITHUB_REPOSITORY | sed 's/.*\///g'`
        PACKAGE_REV="$SHORT_SHA"
        PACKAGE_CONFIG="$GITHUB_CONFIG"
        mkdir -p "$PACKAGE_NAME"
        # Copy files (your existing copy commands)
        if [ -e package-info.json ]; then cp package-info.json "$PACKAGE_NAME"; fi
        if [ -e package-info.json.in ]; then cp package-info.json.in "$PACKAGE_NAME"; fi
        for f in *.md; do [ -e "$f" ] && cp "$f" "$PACKAGE_NAME"; done
        if [ -e icon.png ]; then cp icon.png "$PACKAGE_NAME"; fi
        if [ -e CMakeLists.txt ]; then cp CMakeLists.txt "$PACKAGE_NAME"; fi
        # Copy directories (your existing copy commands)
        if [ -d code ]; then cp -a code "$PACKAGE_NAME"; fi
        if [ -d docs ]; then cp -a docs "$PACKAGE_NAME"; fi
        if [ -d examples ]; then cp -a examples "$PACKAGE_NAME"; fi
        if [ -d extensions ]; then cp -a extensions "$PACKAGE_NAME"; fi
        if [ -d externals ]; then cp -a externals "$PACKAGE_NAME"; fi
        if [ -d extras ]; then cp -a extras "$PACKAGE_NAME"; fi
        if [ -d help ]; then cp -a help "$PACKAGE_NAME"; fi
        if [ -d init ]; then cp -a init "$PACKAGE_NAME"; fi
        if [ -d java-classes ]; then cp -a java-classes "$PACKAGE_NAME"; fi
        if [ -d java-doc ]; then cp -a java-doc "$PACKAGE_NAME"; fi
        if [ -d javascript ]; then cp -a javascript "$PACKAGE_NAME"; fi
        if [ -d jsui ]; then cp -a jsui "$PACKAGE_NAME"; fi
        if [ -d media ]; then cp -a media "$PACKAGE_NAME"; fi
        if [ -d misc ]; then cp -a misc "$PACKAGE_NAME"; fi
        if [ -d patchers ]; then cp -a patchers "$PACKAGE_NAME"; fi
        if [ -d script ]; then cp -a script "$PACKAGE_NAME"; fi
        if [ -d support ]; then cp -a support "$PACKAGE_NAME"; fi
        if [ -d source ]; then cp -a source "$PACKAGE_NAME"; fi
        if [ -d tests ]; then cp -a tests "$PACKAGE_NAME"; fi
        if [ -e "$PACKAGE_NAME/ReadMe-Public.md" ]; then 
          rm -f "$PACKAGE_NAME/ReadMe.md"
          mv "$PACKAGE_NAME/ReadMe-Public.md" "$PACKAGE_NAME/ReadMe.md"
        fi

    - name: package_windows
      if: matrix.os == 'windows-latest'
      shell: cmd
      env:
        GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
        GITHUB_CONFIG: ${{ matrix.config }}
        SHORT_SHA: ${{ steps.sha.outputs.sha }}
      run: |
        set PACKAGE_NAME=%GITHUB_REPOSITORY_NAME%
        mkdir %PACKAGE_NAME%
        if exist extensions xcopy /s /e /i extensions %PACKAGE_NAME%\extensions
        if exist externals xcopy /s /e /i externals %PACKAGE_NAME%\externals
        if exist support xcopy /s /e /i support %PACKAGE_NAME%\support
        if exist tests xcopy /s /e /i tests %PACKAGE_NAME%\tests

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-${{ matrix.config }}-${{ matrix.os }}
        path: ${{ github.event.repository.name }}

  release:
    runs-on: ubuntu-latest
    needs: package
    if: ${{ contains( github.ref, 'refs/tags/' ) }}

    steps:
    - name: Set short SHA
      id: sha
      run: echo "sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

    - uses: actions/download-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-release-windows-latest
        path: ${{ github.event.repository.name }}
        
    - uses: actions/download-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-release-macos-latest
        path: ${{ github.event.repository.name }}
    
    - name: Display structure of downloaded files
      run: ls -R
      working-directory: ${{ github.event.repository.name }}

    - name: zip
      run: zip -r ${{ github.event.repository.name }}-package-for-max-${{ steps.sha.outputs.sha }}.zip ${{ github.event.repository.name }}

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.repository.name }}-${{ steps.sha.outputs.sha }}-zipped-release
        path: ${{ github.event.repository.name }}-package-for-max-${{ steps.sha.outputs.sha }}.zip

    - uses: ncipollo/release-action@v1.12.0
      with:
        artifacts: ${{ github.event.repository.name }}-package-for-max-${{ steps.sha.outputs.sha }}.zip
        body: "Max Package for all supported platforms"
        token: ${{ secrets.GITHUB_TOKEN }}
