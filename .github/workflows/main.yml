name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']  # Trigger on version tags
  pull_request:
    branches: [main, develop]

# Add concurrency to prevent multiple runs on same commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CMAKE_VERSION: '3.27.7'  # Pin CMake version for reproducibility
  BUILD_DIR: 'build'
  PACKAGE_NAME: ${{ github.event.repository.name }}

jobs:
  # Job 1: Code Quality Checks
  clang-tidy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0  # Fetch all history for better analysis
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-tidy \
          clang \
          cmake \
          make \
          ninja-build
    
    - name: Generate compile_commands.json
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        cmake .. -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -G Ninja
    
    - name: Run clang-tidy on all files
      run: |
        cd ${{ env.BUILD_DIR }}
        # Find all C/C++ files in the source directory
        find ../source -name '*.cpp' -o -name '*.hpp' -o -name '*.c' -o -name '*.h' | \
          xargs clang-tidy --quiet 2>/dev/null || true

  # Job 2: Build and Test on Multiple Platforms
  build-test:
    runs-on: ${{ matrix.os }}
    needs: [clang-tidy]  # Run after code quality checks
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        config: [Debug, Release]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 1
    
    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}
    
    - name: Configure CMake
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake .. \
            -G "Visual Studio 17 2022" \
            -A x64 \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_POLICY_VERSION_MINIMUM="3.5" \
            -DBUILD_TESTING=ON
        else
          cmake .. \
            -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=${{ matrix.config }} \
            -DCMAKE_POLICY_VERSION_MINIMUM="3.5" \
            -DBUILD_TESTING=ON
        fi
    
    - name: Build
      run: |
        cd ${{ env.BUILD_DIR }}
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake --build . --config ${{ matrix.config }} --parallel 4
        else
          cmake --build . --config ${{ matrix.config }} --parallel 2
        fi
    
    - name: Run Tests
      run: |
        cd ${{ env.BUILD_DIR }}
        if [ "${{ runner.os }}" = "Windows" ]; then
          ctest -C ${{ matrix.config }} --output-on-failure --parallel 4
        else
          ctest -C ${{ matrix.config }} --output-on-failure --parallel 2
        fi

  # Job 3: Package Release Builds
  package:
    runs-on: ${{ matrix.os }}
    needs: [build-test]  # Only package after successful tests
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        config: [Release]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 1
    
    - name: Set version info
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
          VERSION="main-${GITHUB_SHA:0:7}"
        else
          VERSION="develop-${GITHUB_SHA:0:7}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
    
    - name: Build Release
      run: |
        mkdir -p ${{ env.BUILD_DIR }}
        cd ${{ env.BUILD_DIR }}
        
        if [ "${{ runner.os }}" = "macOS" ]; then
          cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_POLICY_VERSION_MINIMUM="3.5"
        else
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_POLICY_VERSION_MINIMUM="3.5"
        fi
        
        cmake --build . --config Release --parallel 4
    
    - name: Create Package Directory Structure
      run: |
        mkdir -p "${{ env.PACKAGE_NAME }}"
        
        # Copy essential files with proper structure
        cp -r source "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r externals "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r support "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r examples "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        cp -r docs "${{ env.PACKAGE_NAME }}/" 2>/dev/null || true
        
        # Copy root-level files
        for file in *.md LICENSE README* CHANGELOG*; do
          [ -f "$file" ] && cp "$file" "${{ env.PACKAGE_NAME }}/"
        done
        
        # Create package-info.json if it doesn't exist - FIXED INDENTATION
        if [ ! -f "package-info.json" ]; then
          cat > "${{ env.PACKAGE_NAME }}/package-info.json" << 'EOF'
{
  "name": "${{ env.PACKAGE_NAME }}",
  "version": "${{ env.VERSION }}",
  "description": "Max/MSP external built from ${{ github.repository }}",
  "homepage": "https://github.com/${{ github.repository }}",
  "author": "${{ github.actor }}",
  "repository": "${{ github.repository_url }}"
}
EOF
        else
          cp package-info.json "${{ env.PACKAGE_NAME }}/"
        fi
        
        # Add build info file
        {
          echo "Build: ${{ env.VERSION }}"
          echo "Commit: ${{ github.sha }}"
          echo "Date: $(date -u)"
          echo "Platform: ${{ runner.os }}"
        } > "${{ env.PACKAGE_NAME }}/BUILD_INFO"
    
    - name: Package for Distribution
      run: |
        ZIP_NAME="${{ env.PACKAGE_NAME }}-${{ env.VERSION }}-${{ runner.os }}-${{ matrix.config }}.zip"
        
        if [ "${{ runner.os }}" = "macOS" ]; then
          # macOS: Create proper bundle structure
          mkdir -p "${{ env.PACKAGE_NAME }}.mxo"
          cp -r "${{ env.PACKAGE_NAME }}"/* "${{ env.PACKAGE_NAME }}.mxo/" 2>/dev/null || true
          zip -r "$ZIP_NAME" "${{ env.PACKAGE_NAME }}.mxo"
        else
          # Windows: Simple zip
          zip -r "$ZIP_NAME" "${{ env.PACKAGE_NAME }}"
        fi
        
        echo "PACKAGE_PATH=$ZIP_NAME" >> $GITHUB_ENV
    
    - name: Upload Package Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ env.VERSION }}-${{ runner.os }}
        path: ${{ env.PACKAGE_PATH }}
        retention-days: 30

  # Job 4: Create GitHub Release
  release:
    runs-on: ubuntu-latest
    needs: [package]
    if: startsWith(github.ref, 'refs/tags/v')  # Only create releases for version tags
    
    permissions:
      contents: write
    
    steps:
    - name: Download macOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ env.VERSION }}-macOS-latest
        
    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}-${{ env.VERSION }}-Windows-latest
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## Release ${{ github.ref_name }}
          
          **Build Information:**
          - Commit: ${{ github.sha }}
          - Built on: macOS, Windows
          - Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          **Download:** Attached packages for each platform.
          
          ### Installation
          1. Download the appropriate package for your OS
          2. Extract to your Max/MSP packages folder
          3. Restart Max/MSP
          
          ### Supported Platforms
          - macOS (Apple Silicon + Intel)
          - Windows (64-bit)
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}
        files: |
          *-macOS-*.zip
          *-Windows-*.zip
        token: ${{ secrets.GITHUB_TOKEN }}
