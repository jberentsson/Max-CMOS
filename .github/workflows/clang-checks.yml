name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  clang-checks:
    runs-on: ubuntu-latest
    container:  
      image: debian:bookworm  # or debian:bullseye
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Install clang tools
      run: |
        apt-get update && break
        apt-get install -y git clang-format

    - name: Update CA certificates
      run: |
        apt-get update
        apt-get install -y ca-certificates

    - name: Update submodules
      run: |
        update-ca-certificates
        git submodule update --init --remote --recursive
    
    - name: Check code formatting with clang-format
      run: |
        # Only check thulr source files
        find source/projects -name "*.cpp" -o -name "*.hpp" | xargs clang-format --dry-run --Werror

    - name: Check code quality with clang-tidy
      run: |
        # Create compile_commands.json if needed
        mkdir -p build
        cd build
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..
        
        # Run clang-tidy only on thulr source files
        find source/projects -name "*.cpp" | xargs -I {} clang-tidy {} \
          -p . \
          -header-filter='.*' \
          -quiet \
          -checks='-*,bugprone-*,clang-analyzer-*,modernize-*,performance-*,readability-*,-bugprone-branch-clone,-bugprone-easily-swappable-parameters,-modernize-use-trailing-return-type,-readability-identifier-length,-readability-magic-numbers,-readability-function-cognitive-complexity'

    - name: Auto-fix formatting issues
      if: failure()
      run: |
        # Apply clang-format fixes only to thulr
        find source/projects -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i
        
        # Create patch file for review
        git diff > clang-format-fixes.patch
        
        echo "=== Formatting fixes applied to thulr ==="
        echo "Review the changes in clang-format-fixes.patch"
        
#    - uses: actions/upload-artifact@v4
#      if: failure()
#      with:
#        name: clang-format-fixes
#        path: clang-format-fixes.patch
